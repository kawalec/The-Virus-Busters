"use strict";const canvas=document.querySelector(".myCanvas"),ctx=canvas.getContext("2d");let cw=canvas.width=900,ch=canvas.height=450;const allObj=[],allChart=[];let animationID,ballSize=20;const population=100;let timeInfo,apmInfo,globetrotters=50,clicks=0,apm=[];const colorHealthy="#123258",colorInfected="red",wrapper=document.querySelector(".wrapper"),menu=document.querySelector(".menu"),difficult=document.querySelector('input[type="range"]'),diffInfo=document.querySelector(".diff-info span"),about=document.querySelector(".btn--about"),help=document.querySelector(".btn--help"),music=document.querySelector(".btn--music"),start=document.querySelector(".btn--start");class Ball{constructor(e,a,t,i,s,o){this.x=e,this.y=a,this.size=t,this.color=i,this.speedX=s,this.speedY=o}drawBall(e){e.beginPath(),e.fillStyle=this.color,e.arc(this.x,this.y,this.size,0,2*Math.PI,!1),e.fill(),e.closePath(),e.strokeStyle="#fefefe",e.moveTo(this.x,this.y),e.beginPath(),e.arc(this.x,this.y,this.size/2,0,Math.PI,!1),e.stroke(),e.closePath(),e.moveTo(this.x+10,this.y-10),e.beginPath(),e.arc(this.x-6,this.y-8,this.size/8,0,2*Math.PI,!0),e.stroke(),e.closePath(),e.moveTo(this.x+10,this.y-10),e.beginPath(),e.arc(this.x+6,this.y-8,this.size/8,0,2*Math.PI,!0),e.stroke(),e.closePath()}moveBall(e){const a=this.x,t=this.x+this.size,i=this.y+this.size,s=this.y;let o=0;for(let n in e){let l=e[n].x+e[n].size,r=e[n].x,c=e[n].y,d=e[n].y+e[n].size;if(this!==e[n]){if((r<=t&&t<=l||r<=a&&a<=l)&&(c<=s&&s<=d||c<=i&&i<=d)){this.speedX=-this.speedX;break}if(this.speedX>0&&t+this.speedX>cw){o=2;break}if(this.speedX<0&&a-this.speedX<this.size){o=2;break}if(this.speedY>0&&i+this.speedY>ch){o=3;break}if(this.speedY<0&&s-this.speedY<this.size){o=3;break}if(this.speedX>0&&this.speedY>0){if(a<l&&(r<=t+this.speedX&&t+this.speedX<=l||r<=a+this.speedX&&a+this.speedX<=l)&&s<d&&(c<=s-this.speedY&&s-this.speedY<=d||c<=i+this.speedY&&i+this.speedY<=d)){o=1,e[n].color==colorInfected?this.color=colorInfected:this.color==colorInfected&&(e[n].color=colorInfected);break}}else if(this.speedX>0&&this.speedY<0){if(a<l&&(r<=t+this.speedX&&t+this.speedX<=l||r<=a+this.speedX&&a+this.speedX<=l)&&i>c&&(c<=s-this.speedY&&s-this.speedY<=d||c<=i-this.speedY&&i-this.speedY<=d)){o=1;break}}else if(this.speedX<0&&this.speedY>0){if(t>r&&(r<=t-this.speedX&&t-this.speedX<=l||r<=a-this.speedX&&a-this.speedX<=l)&&s<d&&(c<=s-this.speedY&&s-this.speedY<=d||c<=i+this.speedY&&i+this.speedY<=d)){o=1;break}}else if(t>r&&(r<=t-this.speedX&&t-this.speedX<=l||r<=a-this.speedX&&a-this.speedX<=l)&&i>c&&(c<=s-this.speedY&&s-this.speedY<=d||c<=i-this.speedY&&i-this.speedY<=d)){o=1;break}}}o?1==o?(this.speedX=-this.speedX,Math.round(Math.random())&&(this.speedY=-this.speedY)):2==o?this.speedX=-this.speedX:3==o&&(this.speedY=-this.speedY):(this.x+=this.speedX,this.y+=this.speedY)}}class Chart{constructor(e,a,t){this.time=e,this.healthy=a,this.infected=t}}const intRandom=(e,a)=>Math.floor(Math.random()*(a-e+1)+e),updatePosition=(e,a,t)=>{const i=canvas.offsetTop,s=canvas.offsetLeft;e.style.top=`${i+a}px`,e.style.left=`${s+t}px`},delAllObj=e=>e.splice(0,e.length),removeWindow=e=>{wrapper.contains(e)&&e.remove()},updateGameArea=e=>{cw=canvas.width=screen.availWidth>900?900:.95*screen.availWidth,ch=canvas.height=screen.availHeight>450?450:.9*screen.availHeight,wrapper.style.width=screen.availWidth>900?"900px":.95*screen.availWidth+"px",wrapper.style.height=screen.availHeight>515?"515px":.8*screen.availHeight+"px",menu.style.width=screen.availWidth>900?`${cw-65}px`:cw+"px",ballSize=innerWidth>900?20:15,e.map(e=>{e.size=innerWidth>900?20:15})},addObj=e=>{for(let a=0;a<e;a++){const e=new Ball(intRandom(0,cw),intRandom(0,ch),ballSize,"#123258",intRandom(1,2),intRandom(1,2));allObj.push(e)}},infected=(e,a,t)=>{const i=Math.floor(a*t/100)<1?1:Math.floor(a*t/100);for(let a=0;a<i;a++)e[a].color=colorInfected},drawAllObj=(e,a)=>{e.forEach(t=>{a.fillStyle="#000",a.font="normal 16px Arial",a.fillText(clicks,10,20),a.fillText(timeInfo,10,440),a.fillStyle=t.color,t.drawBall(a),t.moveBall(e)})},clearCanvas=(e,a)=>a.clearRect(0,0,cw,ch),animationLoop=()=>{animationID=requestAnimationFrame(animationLoop),clearCanvas(0,ctx),drawAllObj(allObj,ctx)};canvas.addEventListener("click",e=>{clicks++;const a=e.clientX-canvas.offsetLeft,t=e.clientY-canvas.offsetTop;allObj.forEach(e=>{Math.sqrt(Math.pow(a-e.x,2)+Math.pow(t-e.y,2))<40&&(e.color="#123258")})}),difficult.addEventListener("change",e=>{diffInfo.innerHTML=`${difficult.value}`,globetrotters=100*(100-difficult.value)/100},!1),updateGameArea(allObj),window.addEventListener("resize",()=>{updateGameArea(allObj)},!1),start.addEventListener("click",()=>{clicks=0,timeInfo="00:00",delAllObj(apm),clearInterval(goTime),timer(),clearCanvas(0,ctxChart),removeWindow(canvasChart),document.querySelector(".save-chart")&&document.querySelector(".save-chart").remove(),updateGameArea(allObj),cancelAnimationFrame(animationID),delAllObj(allObj),delAllObj(allChart),addObj(globetrotters),infected(allObj,globetrotters,10),animationLoop(),addChart()});const audio=document.querySelector("#myAudio"),playAudio=()=>audio.play(),pauseAudio=()=>audio.pause(),togglePlay=()=>{audio.paused?(music.innerHTML='<i class="fas fa-volume-mute"></i>',audio.play()):(music.innerHTML='<i class="fas fa-volume-up"></i>',audio.pause())};music.addEventListener("click",togglePlay,!1);const countInfected=()=>{let e=0;return allObj.forEach(a=>{a.color===colorInfected&&e++}),e},endGame=e=>{clearInterval(goTime),endGameInfo(e),addCanvasChart(),drawChartFrame(ctxChart),drawChartData(ctxChart,allChart)},addChart=()=>{const e=setInterval(()=>{const a=new Chart(allChart.length,allObj.length-countInfected(),countInfected());allChart.push(a),allObj.length-countInfected()==0&&(clearInterval(e),endGame("lose")),0===countInfected()&&(clearInterval(e),endGame("win"))},1e3)},saveChartBtn=()=>{const e=document.createElement("a");e.classList.add("save-chart"),e.style.top=canvasChart.offsetTop+10+"px",e.style.left=canvasChart.offsetLeft+canvasChart.offsetWidth-25+"px",e.title="Zapisz wykres",e.download="The Virus Busters.png",e.innerHTML='\n  <i class="fas fa-save" onclick="saveChart(canvasChart)"></i>\n  ',wrapper.appendChild(e)},saveChart=e=>{const a=document.querySelector(".save-chart"),t=e.toDataURL("image/png").replace("image/png","image/octet-stream");a.href=t},aboutWindow=document.createElement("div"),addAboutWindow=()=>{aboutWindow.classList.add("about"),aboutWindow.innerHTML='\n<i class="fas fa-times" onclick="removeWindow(aboutWindow)"></i>\n<p class="about__title">The Virus Busters</p>\n<div class="about__links">\n<p>Created by\n<a href="https://www.kawalec.eu" target="_blank">Paweł Kawalec</a>\n</p>\n<p> Images from  \n<a href="https://www.freepik.com" target="_blank">Freepik</a>\n</p>\n<p> Music from  \n<a href="https://www.bensound.com" target="_blank">Bensound</a>\n</p>\n<p> Icons from  \n<a href="https://fontawesome.com" target="_blank">Font Awesome</a>\n</p>\n</div>\n<p class="about__version">TheVirusBusters version 1.1.0</p>\n',updatePosition(aboutWindow,40,40),wrapper.appendChild(aboutWindow)};about.addEventListener("click",()=>{aboutWindow.classList.add("about"),aboutWindow.innerHTML='\n<i class="fas fa-times" onclick="removeWindow(aboutWindow)"></i>\n<p class="about__title">The Virus Busters</p>\n<div class="about__links">\n<p>Created by\n<a href="https://www.kawalec.eu" target="_blank">Paweł Kawalec</a>\n</p>\n<p> Images from  \n<a href="https://www.freepik.com" target="_blank">Freepik</a>\n</p>\n<p> Music from  \n<a href="https://www.bensound.com" target="_blank">Bensound</a>\n</p>\n<p> Icons from  \n<a href="https://fontawesome.com" target="_blank">Font Awesome</a>\n</p>\n</div>\n<p class="about__version">TheVirusBusters version 1.1.0</p>\n',updatePosition(aboutWindow,40,40),wrapper.appendChild(aboutWindow)});const howPlay=document.createElement("div"),addHowPlayWindow=()=>{howPlay.classList.add("play"),howPlay.innerHTML='\n    <i class="fas fa-times" onclick="removeWindow(howPlay)"></i>\n    <div>\n    <p>Zapraszamy dzielnych pogromców wirusów do gry <b>The Virus Busters</b>.</p>\n    <p>Twoim celem w grze będzie wyleczenie wszystkich zainfekowanych wirusem bąbelków. Można to zrobić klikając w zarażony bąbelek.</p>\n    <div class="bubbles play__desktop-info">\n    <div class="bubble bubbleRed"></div>\n    <div class="bubble bubbleBlue"></div>\n    </div>\n    <p>Suwak w menu, domyślnie ustawiony na 50%, pozwoli Ci na decyzję, jaki procent populacji bąbelków zostanie wysłany na kwarantannę. <u>Sprawdź jaki to ma wpływ na grę!</u></p>\n    <p class="play__desktop-info">Przycisk <i class="fas fa-volume-up"></i> w każdej chwili pozwoli Ci włączyć / wyłączyć muzykę w tle.</p>\n    <P class="play__desktop-info">Korzystając z przycisku <i class="fas fa-power-off"></i> możesz uruchomić nową grę. Po jej uruchomieniu populacja bąbelków, których nie wysłałeś na kwarantannę, zacznie siać zarazę wśród pozostałych.</p>\n    <p class="play__desktop-info>Po zakończeniu gry, podsumowanie Twoich osiągnięć zostanie zaprezentowane na wykresie.</p>\n    <p>W ramach <b>nagrody</b> niespodzianki, dostaniesz ważne informacje, które mogą być dla Ciebie bardzo cenne, dlatego przeczytaj uważnie wyskakujący po ukończeniu gry komunikat.</p>\n    </div>\n    ',updatePosition(howPlay,20,20),wrapper.appendChild(howPlay)};help.addEventListener("click",()=>{howPlay.classList.add("play"),howPlay.innerHTML='\n    <i class="fas fa-times" onclick="removeWindow(howPlay)"></i>\n    <div>\n    <p>Zapraszamy dzielnych pogromców wirusów do gry <b>The Virus Busters</b>.</p>\n    <p>Twoim celem w grze będzie wyleczenie wszystkich zainfekowanych wirusem bąbelków. Można to zrobić klikając w zarażony bąbelek.</p>\n    <div class="bubbles play__desktop-info">\n    <div class="bubble bubbleRed"></div>\n    <div class="bubble bubbleBlue"></div>\n    </div>\n    <p>Suwak w menu, domyślnie ustawiony na 50%, pozwoli Ci na decyzję, jaki procent populacji bąbelków zostanie wysłany na kwarantannę. <u>Sprawdź jaki to ma wpływ na grę!</u></p>\n    <p class="play__desktop-info">Przycisk <i class="fas fa-volume-up"></i> w każdej chwili pozwoli Ci włączyć / wyłączyć muzykę w tle.</p>\n    <P class="play__desktop-info">Korzystając z przycisku <i class="fas fa-power-off"></i> możesz uruchomić nową grę. Po jej uruchomieniu populacja bąbelków, których nie wysłałeś na kwarantannę, zacznie siać zarazę wśród pozostałych.</p>\n    <p class="play__desktop-info>Po zakończeniu gry, podsumowanie Twoich osiągnięć zostanie zaprezentowane na wykresie.</p>\n    <p>W ramach <b>nagrody</b> niespodzianki, dostaniesz ważne informacje, które mogą być dla Ciebie bardzo cenne, dlatego przeczytaj uważnie wyskakujący po ukończeniu gry komunikat.</p>\n    </div>\n    ',updatePosition(howPlay,20,20),wrapper.appendChild(howPlay)});const endInfo=document.createElement("div"),endGameInfo=e=>{endInfo.classList.add("end-info"),endInfo.innerHTML="win"===e?'\n  <i class="fas fa-times" onclick="removeWindow(endInfo)"></i>\n  <h2>Gratulacje zwycięstwa!</h2>\n  <p>Jesteś super! Masz bystry umysł i szybkie palce. Szybko klikasz, albo wysłałeś większość bąbelków na kwarantannę, bo doskonale wiesz jakie to ważne i to nie tylko w grze.</p>\n\n  ':'\n  <i class="fas fa-times" onclick="removeWindow(endInfo)"></i>\n  <h2>Tym razem się nie udało.</h2>\n  <p>Nie martw się, to tylko gra. Jeśli zostaniesz w domu, to możesz zagrać ponownie. Jeśli wyślesz więcej bąbelków na kwarantannę, to będzie łatwiej wygrać z wirusem.</p>\n  ',endInfo.innerHTML+='\n  <p>Możesz zagrać ponownie, lub zrobić coś innego, na co zawsze brakowało Ci czasu. Tylko pamiętaj - <b>zostań w domu</b>! Dzięki temu możesz ocalić siebie, albo <b>kogoś bliskiego!</b></p>\n  <p class="important"><i class="fas fa-biohazard"></i> Nie narażaj i nie zarażaj! <i class="fas fa-biohazard"></i></p>\n  <p class="endInfo__desktop">Chociaż czujesz się dobrze, to możesz być nosicielem i zarażać innych. Nawet, jeśli nie jesteś w grupie ryzyka i potencjalnie Twój organizm poradzi sobie z choroba, to pamiętaj, że Twoi najbliżsi mogą nie mieć tyle szczęścia.</p>\n  ',updatePosition(endInfo,20,20),wrapper.appendChild(endInfo)},canvasChart=document.createElement("canvas");canvasChart.setAttribute("class","chart");const ctxChart=canvasChart.getContext("2d");canvasChart.height=400,canvasChart.width=800;const addCanvasChart=()=>{updatePosition(canvasChart,25,45),wrapper.appendChild(canvasChart),saveChartBtn()},drawChartFrame=e=>{e.fillStyle="#fff",e.fillRect(0,0,cw,ch),e.beginPath(),e.strokeStyle="#000",e.moveTo(20,20),e.lineTo(30,30),e.moveTo(20,20),e.lineTo(10,30),e.moveTo(20,20),e.lineTo(20,380),e.lineTo(780,380),e.lineTo(770,370),e.moveTo(780,380),e.lineTo(770,390),e.stroke(),e.closePath(),e.shadowOffsetX=-5,e.shadowOffsetY=5,e.shadowColor="rgba(0,0,0,0.2)",e.shadowBlur=3,e.font="bold 12px sans-serif",e.textAlign="end",e.fillStyle="#000",e.fillText(clicks,790,170),e.fillText(Math.trunc(60*clicks/(apm.length-1)),790,150),e.fillText(timeInfo,790,130),e.textAlign="start",e.fillText("czas gry:",700,130),e.fillText("kliknięcia:",700,170),e.fillText("APM:",700,150),e.fillText("zdrowi",735,220),e.fillText("chorzy",735,240),e.fillText("APS",735,260),e.fillText("infekcje",2,14),e.fillText("czas",735,395),e.beginPath(),e.moveTo(15,190),e.setLineDash([10,10]),e.lineTo(790,190),e.moveTo(15,95),e.lineTo(790,95),e.moveTo(15,285),e.lineTo(790,285),e.stroke(),e.closePath(),e.font="bold 10px sans-serif",e.fillText(Math.round(3*allObj.length/4),2,98),e.fillText(Math.round(allObj.length/2),2,193),e.fillText(Math.round(allObj.length/4),2,288),e.beginPath(),e.strokeStyle="#123258",e.moveTo(710,216),e.lineTo(730,216),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle=colorInfected,e.moveTo(710,236),e.lineTo(730,236),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle="#000",e.moveTo(710,256),e.lineTo(730,256),e.stroke(),e.closePath()},drawChartData=(e,a)=>{const t=.9*canvasChart.width/a.length,i=.9*canvasChart.height/allObj.length,s=380-i*a[0].infected;e.beginPath(),e.strokeStyle=colorInfected,e.setLineDash([]),e.moveTo(30,s),a.forEach(a=>{e.lineTo(30+a.time*t,380-i*a.infected)}),e.stroke(),e.closePath();const o=380-i*a[0].healthy;e.beginPath(),e.strokeStyle="#123258",e.setLineDash([]),e.moveTo(30,o),a.forEach(a=>{e.lineTo(30+a.time*t,380-i*a.healthy)}),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle="#000",e.moveTo(20,380),apm.forEach((a,s)=>{e.lineTo(20+s*t,380-a*i)}),e.stroke(),e.closePath()};let goTime;const timer=()=>{let e=0;apm.push(0),goTime=setInterval(()=>{e++;let a=Math.floor(e/60)<10?`0${Math.floor(e/60)}`:`${Math.floor(e/60)}`;timeInfo=e>=6e3?"Time is over!":e%60<10?`${a}:0${e%60}`:`${a}:${e%60}`,apm.push(clicks-apm.reduce((e,a)=>e+a))},1e3)};